name: æ„å»ºå’Œå‘å¸ƒ

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            artifact_name: windows
            executable: TomatoNovelDownloader.exe
          - os: ubuntu-latest
            artifact_name: linux
            executable: TomatoNovelDownloader
          - os: macos-latest
            artifact_name: macos
            executable: TomatoNovelDownloader
    
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: ç”Ÿæˆç‰ˆæœ¬å·
      id: version
      shell: bash
      run: |
        VERSION=$(python -c "import datetime; print(datetime.datetime.now().strftime('%Y.%m.%d.%H%M'))")-$(echo ${{ github.sha }} | cut -c1-7)
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Generated version: $VERSION"
      
    - name: åˆ›å»ºç‰ˆæœ¬æ–‡ä»¶
      shell: bash
      run: |
        cat > version.py << 'EOF'
        # -*- coding: utf-8 -*-
        VERSION = "${{ steps.version.outputs.VERSION }}"
        BUILD_TIME = "$(date +'%Y.%m.%d.%H%M')"
        COMMIT_HASH = "${{ github.sha }}"
        BRANCH = "${{ github.ref_name }}"
        IS_COMPILED_VERSION = True
        
        def get_version_info():
            return {
                'version': VERSION,
                'build_time': BUILD_TIME,
                'commit_hash': COMMIT_HASH,
                'branch': BRANCH,
                'is_compiled': IS_COMPILED_VERSION
            }
        
        def get_version_string():
            return f"v{VERSION}"
            
        def is_development_version():
            return False
            
        def get_base_version():
            if '-' in VERSION:
                return VERSION.split('-')[0]
            return VERSION
        EOF

    - name: å®‰è£…ç³»ç»Ÿä¾èµ– (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-tk tk-dev

    - name: å®‰è£…ç³»ç»Ÿä¾èµ– (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install tcl-tk || true

    - name: ç¼“å­˜Pythonä¾èµ–
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: å‡çº§pip
      run: |
        python -m pip install --upgrade pip

    - name: å®‰è£…ä¾èµ–
      run: |
        pip install -r requirements.txt
        pip install pyinstaller

    - name: éªŒè¯ä¾èµ–å®‰è£…
      run: |
        python -c "import requests, PIL, ebooklib, bs4, fake_useragent, tqdm; print('æ‰€æœ‰ä¾èµ–å®‰è£…æˆåŠŸ')"

    - name: æ£€æŸ¥æ„å»ºè„šæœ¬
      run: |
        if [ -f "build_app.py" ]; then
          echo "æ‰¾åˆ°æ„å»ºè„šæœ¬ build_app.py"
        else
          echo "æœªæ‰¾åˆ°æ„å»ºè„šæœ¬ï¼Œå°†ä½¿ç”¨é»˜è®¤PyInstallerå‘½ä»¤"
        fi
      shell: bash

    - name: æ„å»ºåº”ç”¨
      run: |
        if [ -f "build_app.py" ]; then
          python build_app.py
        else
          # é»˜è®¤æ„å»ºå‘½ä»¤
          if [ -f "gui.py" ]; then
            pyinstaller --onefile --windowed --name=TomatoNovelDownloader gui.py
          elif [ -f "main.py" ]; then
            pyinstaller --onefile --name=TomatoNovelDownloader main.py
          else
            echo "æœªæ‰¾åˆ°ä¸»ç¨‹åºæ–‡ä»¶"
            exit 1
          fi
        fi
      shell: bash

    - name: éªŒè¯æ„å»ºç»“æœ
      run: |
        if [ -f "dist/${{ matrix.executable }}" ]; then
          echo "æ„å»ºæˆåŠŸ: dist/${{ matrix.executable }}"
          ls -la dist/
        else
          echo "æ„å»ºå¤±è´¥ï¼Œæœªæ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶"
          ls -la dist/ || echo "distç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
      shell: bash

    - name: åˆ›å»ºå‘å¸ƒåŒ…
      run: |
        mkdir -p release
        cp "dist/${{ matrix.executable }}" "release/"
        
        # åˆ›å»ºå‹ç¼©åŒ…
        cd release
        if [ "${{ runner.os }}" = "Windows" ]; then
          7z a "../TomatoNovelDownloader-${{ steps.version.outputs.VERSION }}-${{ matrix.artifact_name }}.zip" .
        else
          zip -r "../TomatoNovelDownloader-${{ steps.version.outputs.VERSION }}-${{ matrix.artifact_name }}.zip" .
        fi
        cd ..
        
        # åˆ›å»ºæ›´æ–°ä¿¡æ¯
        cat > "update_info_${{ matrix.artifact_name }}.json" << EOF
        {
          "version": "${{ steps.version.outputs.VERSION }}",
          "platform": "${{ matrix.artifact_name }}",
          "build_time": "$(date +'%Y.%m.%d.%H%M')",
          "download_url": "https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.VERSION }}/TomatoNovelDownloader-${{ steps.version.outputs.VERSION }}-${{ matrix.artifact_name }}.zip",
          "changelog": "è‡ªåŠ¨æ„å»ºç‰ˆæœ¬ ${{ steps.version.outputs.VERSION }}",
          "commit": "${{ github.sha }}",
          "branch": "${{ github.ref_name }}"
        }
        EOF
      shell: bash

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: TomatoNovelDownloader-${{ steps.version.outputs.VERSION }}-${{ matrix.artifact_name }}
        path: |
          TomatoNovelDownloader-${{ steps.version.outputs.VERSION }}-${{ matrix.artifact_name }}.zip
          update_info_${{ matrix.artifact_name }}.json
        
  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    permissions:
      contents: write
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        path: artifacts/

    - name: è·å–ç‰ˆæœ¬å·
      id: get_version
      run: |
        # ä»ä»»æ„ä¸€ä¸ªæ›´æ–°ä¿¡æ¯æ–‡ä»¶ä¸­æå–ç‰ˆæœ¬å·
        VERSION=$(find artifacts -name "update_info_*.json" | head -1 | xargs cat | python3 -c "import sys, json; print(json.load(sys.stdin)['version'])")
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Found version: $VERSION"

    - name: æ•´ç†å‘å¸ƒæ–‡ä»¶
      run: |
        mkdir -p release
        find artifacts -name "*.zip" -exec cp {} release/ \;
        find artifacts -name "*.json" -exec cp {} release/ \;
        ls -la release/

    - name: åˆ›å»ºRelease
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ steps.get_version.outputs.VERSION }}
        name: TomatoNovelDownloader v${{ steps.get_version.outputs.VERSION }}
        body: |
          ## ğŸš€ è‡ªåŠ¨æ„å»ºç‰ˆæœ¬ ${{ steps.get_version.outputs.VERSION }}

          **æ„å»ºä¿¡æ¯:**
          - æ„å»ºæ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')
          - æäº¤å“ˆå¸Œ: ${{ github.sha }}
          - åˆ†æ”¯: ${{ github.ref_name }}

          **ä¸‹è½½è¯´æ˜:**
          - Windows: `TomatoNovelDownloader-${{ steps.get_version.outputs.VERSION }}-windows.zip`
          - Linux: `TomatoNovelDownloader-${{ steps.get_version.outputs.VERSION }}-linux.zip`
          - macOS: `TomatoNovelDownloader-${{ steps.get_version.outputs.VERSION }}-macos.zip`

          **æ›´æ–°å†…å®¹:**
          ${{ github.event.head_commit.message }}

        files: release/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}