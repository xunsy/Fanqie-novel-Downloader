name: è‡ªåŠ¨ç¼–è¯‘å‘å¸ƒ

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    strategy:
      fail-fast: false  # ä¸è¦å› ä¸ºä¸€ä¸ªå¹³å°å¤±è´¥å°±å–æ¶ˆå…¶ä»–å¹³å°
      matrix:
        include:
          - os: windows-latest
            executable_suffix: .exe
            artifact_name: windows
          - os: ubuntu-latest
            executable_suffix: ""
            artifact_name: linux
          - os: macos-latest
            executable_suffix: ""
            artifact_name: macos
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: ç”Ÿæˆç‰ˆæœ¬å·
      id: version
      run: |
        python -c '
import datetime
import os
timestamp = datetime.datetime.now().strftime("%Y.%m.%d.%H%M")
commit_short = os.environ.get("GITHUB_SHA", "")[:7]
version = f"{timestamp}-{commit_short}"
print(f"VERSION={version}")
print(f"TIMESTAMP={timestamp}")
with open(os.environ.get("GITHUB_OUTPUT", "output.txt"), "a") as f:
    f.write(f"VERSION={version}\n")
    f.write(f"TIMESTAMP={timestamp}\n")
print(f"Generated version: {version}")
        '
      
    - name: æ›´æ–°ç‰ˆæœ¬ä¿¡æ¯
      run: |
        python -c "
import os

version = os.environ.get('VERSION', '${{ steps.version.outputs.VERSION }}')
timestamp = os.environ.get('TIMESTAMP', '${{ steps.version.outputs.TIMESTAMP }}')
commit_hash = os.environ.get('GITHUB_SHA', '')
branch = os.environ.get('GITHUB_REF_NAME', '')

version_py_content = '''# -*- coding: utf-8 -*-
# ç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶ - ç”±GitHub Actionsè‡ªåŠ¨ç”Ÿæˆ

import os

VERSION = \"{version}\"
BUILD_TIME = \"{timestamp}\"
COMMIT_HASH = \"{commit_hash}\"
BRANCH = \"{branch}\"
IS_COMPILED_VERSION = True

def get_version_info():
    return {{
        'version': VERSION,
        'build_time': BUILD_TIME,
        'commit_hash': COMMIT_HASH,
        'branch': BRANCH,
        'is_compiled': IS_COMPILED_VERSION
    }}

def get_version_string():
    return f\"v{{VERSION}}\"
    
def is_development_version():
    \"\"\"åˆ¤æ–­æ˜¯å¦ä¸ºå¼€å‘ç‰ˆæœ¬\"\"\"
    return False  # ç¼–è¯‘ç‰ˆæœ¬æ€»æ˜¯è¿”å›False
    
def get_base_version():
    \"\"\"è·å–åŸºç¡€ç‰ˆæœ¬å·ï¼ˆä¸åŒ…å«commit hashï¼‰ç”¨äºç‰ˆæœ¬æ¯”è¾ƒ\"\"\"
    if '-' in VERSION:
        return VERSION.split('-')[0]
    return VERSION
'''

with open('version.py', 'w', encoding='utf-8') as f:
    f.write(version_py_content.format(version=version, timestamp=timestamp, commit_hash=commit_hash, branch=branch))

print('Version file created:')
with open('version.py', 'r', encoding='utf-8') as f:
    print(f.read())
"

    - name: å®‰è£…ç³»ç»Ÿä¾èµ– (ä»…Linux)
      if: runner.os == 'Linux'
      run: |
        python -c "
import subprocess
import sys

print('æ­£åœ¨å®‰è£…Linuxç³»ç»Ÿä¾èµ–...')
try:
    subprocess.run(['sudo', 'apt-get', 'update'], check=True)
    subprocess.run(['sudo', 'apt-get', 'install', '-y', 'python3-tk', 'tk-dev', 'libxml2-dev', 'libxslt1-dev', 'python3-dev'], check=True)
    print('âœ… Linuxç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ')
except subprocess.CalledProcessError as e:
    print(f'âŒ Linuxç³»ç»Ÿä¾èµ–å®‰è£…å¤±è´¥: {e}')
    sys.exit(1)
"

    - name: å®‰è£…ç³»ç»Ÿä¾èµ– (ä»…macOS)
      if: runner.os == 'macOS'
      run: |
        python -c "
import subprocess
import sys

print('æ­£åœ¨å®‰è£…macOSç³»ç»Ÿä¾èµ–...')
try:
    subprocess.run(['brew', 'update'], check=False)
    subprocess.run(['brew', 'install', 'tcl-tk', 'libxml2', 'libxslt'], check=False)
    print('âœ… macOSç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ')
except Exception as e:
    print(f'âš ï¸ macOSç³»ç»Ÿä¾èµ–å®‰è£…å‡ºç°é—®é¢˜: {e}')
    print('ç»§ç»­æ‰§è¡Œï¼Œå› ä¸ºè¿™äº›ä¾èµ–å¯èƒ½ä¸æ˜¯å¿…éœ€çš„')
"

    - name: ç¼“å­˜Pythonä¾èµ–
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: å®‰è£…Pythonä¾èµ–
      run: |
        python -c "
import subprocess
import sys
import os

# å‡çº§pip
print('å‡çº§pip...')
subprocess.run([sys.executable, '-m', 'pip', 'install', '--upgrade', 'pip'], check=True)

print('å®‰è£…requirements.txtä¸­çš„ä¾èµ–...')
# å°è¯•å®‰è£…æ‰€æœ‰ä¾èµ–
try:
    subprocess.run([sys.executable, '-m', 'pip', 'install', '-r', 'requirements.txt'], check=True)
    print('âœ… æ‰¹é‡å®‰è£…ä¾èµ–æˆåŠŸ')
except subprocess.CalledProcessError:
    print('âš ï¸ æ‰¹é‡å®‰è£…å¤±è´¥ï¼Œå°è¯•é€ä¸ªå®‰è£…...')
    dependencies = [
        'requests>=2.28.0,<3.0.0',
        'Pillow>=9.0.0,<11.0.0',
        'ebooklib>=0.18,<0.19',
        'fake-useragent>=1.5.0,<2.0.0',
        'tqdm>=4.65.0,<5.0.0',
        'beautifulsoup4>=4.12.0,<5.0.0',
        'urllib3>=1.26.0,<3.0.0'
    ]
    
    for dep in dependencies:
        try:
            subprocess.run([sys.executable, '-m', 'pip', 'install', dep], check=True)
            print(f'âœ… {dep} å®‰è£…æˆåŠŸ')
        except subprocess.CalledProcessError:
            print(f'âŒ {dep} å®‰è£…å¤±è´¥')
    
    # å®‰è£…å¯é€‰ä¾èµ–
    try:
        subprocess.run([sys.executable, '-m', 'pip', 'install', 'pillow-heif>=1.0.0'], check=True)
        print('âœ… pillow-heif å®‰è£…æˆåŠŸ')
    except subprocess.CalledProcessError:
        print('âš ï¸ pillow-heifå®‰è£…å¤±è´¥ï¼Œä½†è¿™æ˜¯å¯é€‰çš„')

# å®‰è£…PyInstaller
print('å®‰è£…PyInstaller...')
subprocess.run([sys.executable, '-m', 'pip', 'install', 'pyinstaller'], check=True)

# éªŒè¯å…³é”®ä¾èµ–
print('éªŒè¯å…³é”®ä¾èµ–æ˜¯å¦å®‰è£…æˆåŠŸ...')
modules = [
    ('bs4', 'beautifulsoup4/bs4'),
    ('fake_useragent', 'fake_useragent'),
    ('tqdm', 'tqdm'),
    ('requests', 'requests'),
    ('PIL', 'Pillow'),
    ('ebooklib', 'ebooklib')
]

failed_modules = []
for module, name in modules:
    try:
        __import__(module)
        print(f'âœ… {name} å®‰è£…æˆåŠŸ')
    except ImportError:
        print(f'âŒ {name} å®‰è£…å¤±è´¥')
        failed_modules.append(name)

if failed_modules:
    print(f'ä»¥ä¸‹æ¨¡å—å®‰è£…å¤±è´¥: {\", \".join(failed_modules)}')
    sys.exit(1)
else:
    print('æ‰€æœ‰ä¾èµ–å®‰è£…éªŒè¯å®Œæˆï¼')
"

    - name: æµ‹è¯•æ¨¡å—å¯¼å…¥
      run: |
        python -c "
import sys
import os

print('è¿è¡Œå®Œæ•´çš„æ¨¡å—å¯¼å…¥æµ‹è¯•...')

# æ£€æŸ¥æ˜¯å¦å­˜åœ¨test_imports.pyæ–‡ä»¶
if os.path.exists('test_imports.py'):
    print('æ‰§è¡Œtest_imports.py...')
    try:
        import test_imports
        print('âœ… test_imports.py æ‰§è¡ŒæˆåŠŸ')
    except Exception as e:
        print(f'âŒ test_imports.py æ‰§è¡Œå¤±è´¥: {e}')
        sys.exit(1)
else:
    print('âš ï¸ test_imports.py ä¸å­˜åœ¨ï¼Œè·³è¿‡æ¨¡å—å¯¼å…¥æµ‹è¯•')
    print('æ‰‹åŠ¨æµ‹è¯•å…³é”®æ¨¡å—...')
    
    modules = [
        'requests', 'PIL', 'ebooklib', 'bs4', 'fake_useragent', 
        'tqdm', 'urllib3', 'tkinter'
    ]
    
    failed_modules = []
    for module in modules:
        try:
            __import__(module)
            print(f'âœ… {module} å¯¼å…¥æˆåŠŸ')
        except ImportError as e:
            print(f'âŒ {module} å¯¼å…¥å¤±è´¥: {e}')
            failed_modules.append(module)
    
    if failed_modules:
        print(f'ä»¥ä¸‹æ¨¡å—å¯¼å…¥å¤±è´¥: {\", \".join(failed_modules)}')
        sys.exit(1)
    else:
        print('âœ… æ‰€æœ‰å…³é”®æ¨¡å—å¯¼å…¥æˆåŠŸ')
"

    - name: æ£€æŸ¥æ–‡ä»¶å­˜åœ¨æ€§
      run: |
        python -c "
import os
import glob

print('å½“å‰ç›®å½•æ–‡ä»¶åˆ—è¡¨:')
for item in os.listdir('.'):
    if os.path.isdir(item):
        print(f'  [DIR] {item}')
    else:
        print(f'  [FILE] {item}')

print('æŸ¥æ‰¾Pythonæ–‡ä»¶:')
py_files = glob.glob('**/*.py', recursive=True)
for py_file in py_files:
    print(f'  {py_file}')

print('æ£€æŸ¥å…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨:')
key_files = ['gui.py', 'build.spec', 'requirements.txt']
for file in key_files:
    if os.path.exists(file):
        print(f'  âœ… {file} å­˜åœ¨')
    else:
        print(f'  âŒ {file} ä¸å­˜åœ¨')
"

    - name: ç¼–è¯‘å¯æ‰§è¡Œæ–‡ä»¶
      run: |
        python build_app.py

    - name: åˆ›å»ºå‘å¸ƒåŒ…
      run: |
        python -c "
import os
import zipfile
import json
import shutil

version = os.environ.get('VERSION', '${{ steps.version.outputs.VERSION }}')
artifact_name = '${{ matrix.artifact_name }}'
repository = os.environ.get('GITHUB_REPOSITORY', '${{ github.repository }}')
timestamp = os.environ.get('TIMESTAMP', '${{ steps.version.outputs.TIMESTAMP }}')
commit_hash = os.environ.get('GITHUB_SHA', '${{ github.sha }}')
branch_name = os.environ.get('GITHUB_REF_NAME', '${{ github.ref_name }}')

# åˆ›å»ºå‘å¸ƒç›®å½•ç»“æ„
release_dir = f'release/TomatoNovelDownloader-{version}-{artifact_name}'
os.makedirs(release_dir, exist_ok=True)

# æ ¹æ®å¹³å°å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
if os.name == 'nt':  # Windows
    src_exe = 'dist/TomatoNovelDownloader.exe'
    dst_exe = f'{release_dir}/TomatoNovelDownloader.exe'
else:  # Linux/macOS
    src_exe = 'dist/TomatoNovelDownloader'
    dst_exe = f'{release_dir}/TomatoNovelDownloader'

if os.path.exists(src_exe):
    shutil.copy(src_exe, dst_exe)
    if os.name != 'nt':
        os.chmod(dst_exe, 0o755)
    print(f'âœ… å¯æ‰§è¡Œæ–‡ä»¶å·²å¤åˆ¶: {dst_exe}')
else:
    print(f'âŒ æœªæ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶: {src_exe}')
    if os.path.exists('dist'):
        print('distç›®å½•å†…å®¹:')
        for f in os.listdir('dist'):
            print(f'  {f}')
    exit(1)

# åˆ›å»ºå‹ç¼©åŒ…
zip_filename = f'release/TomatoNovelDownloader-{version}-{artifact_name}.zip'
with zipfile.ZipFile(zip_filename, 'w', zipfile.ZIP_DEFLATED) as zipf:
    for root, dirs, files in os.walk(release_dir):
        for file in files:
            file_path = os.path.join(root, file)
            arc_path = os.path.relpath(file_path, 'release')
            zipf.write(file_path, arc_path)

print('âœ… å‹ç¼©åŒ…åˆ›å»ºå®Œæˆ')

# åˆ›å»ºæ›´æ–°ä¿¡æ¯æ–‡ä»¶
update_info = {
    'version': version,
    'platform': artifact_name,
    'build_time': timestamp,
    'download_url': f'https://github.com/{repository}/releases/download/v{version}/TomatoNovelDownloader-{version}-{artifact_name}.zip',
    'changelog': f'è‡ªåŠ¨æ„å»ºç‰ˆæœ¬ {version}',
    'commit': commit_hash,
    'branch': branch_name
}

update_info_file = f'release/update_info_{artifact_name}.json'
with open(update_info_file, 'w', encoding='utf-8') as f:
    json.dump(update_info, f, ensure_ascii=False, indent=2)

print('å‘å¸ƒåŒ…åˆ›å»ºå®Œæˆï¼š')
for f in os.listdir('release'):
    print(f'  {f}')

print('å‹ç¼©åŒ…å†…å®¹ï¼š')
with zipfile.ZipFile(zip_filename, 'r') as zipf:
    for info in zipf.infolist():
        print(f'  {info.filename}')
"

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: TomatoNovelDownloader-${{ steps.version.outputs.VERSION }}-${{ matrix.artifact_name }}
        path: release/
        
  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    permissions:
      contents: write
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        path: artifacts/

    - name: è·å–æœ€æ–°çš„ç‰ˆæœ¬å·
      id: get_version
      run: |
        python -c "
import os
import json
import glob

# ä»ä¸‹è½½çš„æ„å»ºäº§ç‰©ä¸­æå–ç‰ˆæœ¬å·
version_files = glob.glob('artifacts/*/update_info_*.json')
if version_files:
    with open(version_files[0], 'r', encoding='utf-8') as f:
        data = json.load(f)
        version = data['version']
        timestamp = data['build_time']
        with open(os.environ.get('GITHUB_OUTPUT', 'output.txt'), 'a') as out:
            out.write(f'VERSION={version}\n')
            out.write(f'TIMESTAMP={timestamp}\n')
        print(f'Found version: {version}')
else:
    # fallbackæ–¹æ¡ˆ
    import datetime
    timestamp = datetime.datetime.now().strftime('%Y.%m.%d.%H%M')
    commit_short = os.environ.get('GITHUB_SHA', '')[:7]
    version = f'{timestamp}-{commit_short}'
    with open(os.environ.get('GITHUB_OUTPUT', 'output.txt'), 'a') as out:
        out.write(f'VERSION={version}\n')
        out.write(f'TIMESTAMP={timestamp}\n')
    print(f'Fallback version: {version}')
"

    - name: æ•´ç†å‘å¸ƒæ–‡ä»¶
      run: |
        python -c "
import os
import shutil
import glob

print('æ•´ç†å‘å¸ƒæ–‡ä»¶...')
os.makedirs('release', exist_ok=True)

# å¤åˆ¶æ‰€æœ‰zipæ–‡ä»¶
zip_files = glob.glob('artifacts/*/*.zip')
for zip_file in zip_files:
    shutil.copy(zip_file, 'release/')
    print(f'  å·²å¤åˆ¶: {os.path.basename(zip_file)}')

# å¤åˆ¶æ‰€æœ‰jsonæ–‡ä»¶
json_files = glob.glob('artifacts/*/*.json')
for json_file in json_files:
    shutil.copy(json_file, 'release/')
    print(f'  å·²å¤åˆ¶: {os.path.basename(json_file)}')

print('releaseç›®å½•å†…å®¹:')
for f in os.listdir('release'):
    print(f'  {f}')
"

    - name: åˆ›å»ºRelease
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ steps.get_version.outputs.VERSION }}
        name: TomatoNovelDownloader v${{ steps.get_version.outputs.VERSION }}
        body: |
          ## ğŸš€ è‡ªåŠ¨æ„å»ºç‰ˆæœ¬ ${{ steps.get_version.outputs.VERSION }}

          **æ„å»ºä¿¡æ¯:**
          - æ„å»ºæ—¶é—´: ${{ steps.get_version.outputs.TIMESTAMP }}
          - æäº¤å“ˆå¸Œ: ${{ github.sha }}
          - åˆ†æ”¯: ${{ github.ref_name }}

          **ä¸‹è½½è¯´æ˜:**
          - Windows: `TomatoNovelDownloader-${{ steps.get_version.outputs.VERSION }}-windows.zip`
          - Linux: `TomatoNovelDownloader-${{ steps.get_version.outputs.VERSION }}-linux.zip`
          - macOS: `TomatoNovelDownloader-${{ steps.get_version.outputs.VERSION }}-macos.zip`

          **æ›´æ–°å†…å®¹:**
          ${{ github.event.head_commit.message }}

        files: release/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}