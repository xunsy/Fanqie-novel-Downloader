name: è‡ªåŠ¨ç¼–è¯‘å‘å¸ƒ

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    strategy:
      fail-fast: false  # ä¸è¦å› ä¸ºä¸€ä¸ªå¹³å°å¤±è´¥å°±å–æ¶ˆå…¶ä»–å¹³å°
      matrix:
        include:
          - os: windows-latest
            executable_suffix: .exe
            artifact_name: windows
          - os: ubuntu-latest
            executable_suffix: ""
            artifact_name: linux
          - os: macos-latest
            executable_suffix: ""
            artifact_name: macos
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: ç”Ÿæˆç‰ˆæœ¬å·
      id: version
      run: |
        if [ "${{ runner.os }}" = "Windows" ]; then
          timestamp=$(powershell -Command "Get-Date -Format 'yyyy.MM.dd.HHmm'")
          commit_short="${{ github.sha }}"
          commit_short=${commit_short:0:7}
        else
          timestamp=$(date +"%Y.%m.%d.%H%M")
          commit_short="${{ github.sha }}"
          commit_short=${commit_short:0:7}
        fi
        version="$timestamp-$commit_short"
        echo "VERSION=$version" >> $GITHUB_OUTPUT
        echo "TIMESTAMP=$timestamp" >> $GITHUB_OUTPUT
        echo "Generated version: $version"
      shell: bash
      
    - name: æ›´æ–°ç‰ˆæœ¬ä¿¡æ¯
      run: |
        version="${{ steps.version.outputs.VERSION }}"
        timestamp="${{ steps.version.outputs.TIMESTAMP }}"

        # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
        cat > version.py << 'EOF'
        # -*- coding: utf-8 -*-
        # ç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶ - ç”±GitHub Actionsè‡ªåŠ¨ç”Ÿæˆ
        # æ„å»ºæ—¶é—´: $timestamp

        VERSION="$version"
        BUILD_TIME="$timestamp"
        COMMIT_HASH="${{ github.sha }}"
        BRANCH="${{ github.ref_name }}"

        def get_version_info():
            return {
                'version': VERSION,
                'build_time': BUILD_TIME,
                'commit_hash': COMMIT_HASH,
                'branch': BRANCH
            }

        def get_version_string():
            return f"v{VERSION}"
        EOF

        # åˆ é™¤8ä¸ªå‰å¯¼ç©ºæ ¼ï¼Œé¿å… Python ç¼©è¿›é”™è¯¯
        sed -i.bak 's/^        //' version.py && rm -f version.py.bak

        echo "Version file created:"
        cat version.py
      shell: bash
      
    - name: å®‰è£…ç³»ç»Ÿä¾èµ–
      if: runner.os != 'Windows'
      run: |
        if [ "${{ runner.os }}" = "Linux" ]; then
          sudo apt-get update
          sudo apt-get install -y python3-tk tk-dev libxml2-dev libxslt1-dev python3-dev
        elif [ "${{ runner.os }}" = "macOS" ]; then
          brew update || true
          brew install tcl-tk libxml2 libxslt || true
        fi
      shell: bash

    - name: å®‰è£…Pythonä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: æ£€æŸ¥æ–‡ä»¶å­˜åœ¨æ€§
      run: |
        echo "å½“å‰ç›®å½•æ–‡ä»¶åˆ—è¡¨:"
        ls -la
        echo "æŸ¥æ‰¾Pythonæ–‡ä»¶:"
        find . -name "*.py" -type f
        echo "æ£€æŸ¥GUI.pyæ˜¯å¦å­˜åœ¨:"
        if [ -f "GUI.py" ]; then
          echo "âœ… GUI.py å­˜åœ¨"
        else
          echo "âŒ GUI.py ä¸å­˜åœ¨"
        fi
      shell: bash

    - name: ç¼–è¯‘å¯æ‰§è¡Œæ–‡ä»¶
      working-directory: Fanqie-novel-Downloader
      run: |
        # åˆ›å»ºPyInstalleré…ç½®
        app_name="TomatoNovelDownloader-${{ steps.version.outputs.VERSION }}-${{ matrix.artifact_name }}"



        # Windowså¹³å°ç¼–è¯‘
        pyinstaller build.spec

        # å¤åˆ¶å¿…è¦æ–‡ä»¶åˆ°distç›®å½•
        if [ -d "dist" ]; then
          cp README.md dist/ 2>/dev/null || true
          cp requirements.txt dist/ 2>/dev/null || true
          cp version.py dist/ 2>/dev/null || true
        fi
      shell: bash
      
    - name: åˆ›å»ºå‘å¸ƒåŒ…
      run: |
        version="${{ steps.version.outputs.VERSION }}"
        artifact_name="${{ matrix.artifact_name }}"

        # åˆ›å»ºå‘å¸ƒç›®å½•
        mkdir -p release

        if [ "${{ runner.os }}" = "Windows" ]; then
          # Windows ä½¿ç”¨ PowerShell è‡ªå¸¦çš„ Compress-Archive
          powershell -Command "Compress-Archive -Path 'dist/*' -DestinationPath 'release/TomatoNovelDownloader-$version-$artifact_name.zip'"
        else
          # Linux/macOS ä½¿ç”¨ zip å‘½ä»¤
          zip -r "release/TomatoNovelDownloader-$version-$artifact_name.zip" dist/*
        fi

        # åˆ›å»ºæ›´æ–°ä¿¡æ¯æ–‡ä»¶
        cat > "release/update_info_$artifact_name.json" << EOF
        {
          "version": "$version",
          "platform": "$artifact_name",
          "build_time": "${{ steps.version.outputs.TIMESTAMP }}",
          "download_url": "https://github.com/${{ github.repository }}/releases/download/v$version/TomatoNovelDownloader-$version-$artifact_name.zip",
          "changelog": "è‡ªåŠ¨æ„å»ºç‰ˆæœ¬ $version",
          "commit": "${{ github.sha }}",
          "branch": "${{ github.ref_name }}"
        }
        EOF

        echo "Release package created:"
        ls -la release/
      shell: bash
      
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: TomatoNovelDownloader-${{ steps.version.outputs.VERSION }}-${{ matrix.artifact_name }}
        path: release/
        
  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    permissions:
      contents: write
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ç”Ÿæˆç‰ˆæœ¬å·
      id: version
      run: |
        timestamp=$(date +"%Y.%m.%d.%H%M")
        commit_short="${{ github.sha }}"
        commit_short=${commit_short:0:7}
        version="$timestamp-$commit_short"
        echo "VERSION=$version" >> $GITHUB_OUTPUT
        echo "TIMESTAMP=$timestamp" >> $GITHUB_OUTPUT

    - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        path: artifacts/

    - name: æ•´ç†å‘å¸ƒæ–‡ä»¶
      run: |
        mkdir -p release
        find artifacts/ -name "*.zip" -exec cp {} release/ \;
        find artifacts/ -name "*.json" -exec cp {} release/ \;
        ls -la release/

    - name: åˆ›å»ºRelease
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ steps.version.outputs.VERSION }}
        name: TomatoNovelDownloader v${{ steps.version.outputs.VERSION }}
        body: |
          ## ğŸš€ Windowsè‡ªåŠ¨æ„å»ºç‰ˆæœ¬ ${{ steps.version.outputs.VERSION }}

          **æ„å»ºä¿¡æ¯:**
          - æ„å»ºæ—¶é—´: ${{ steps.version.outputs.TIMESTAMP }}
          - æäº¤å“ˆå¸Œ: ${{ github.sha }}
          - åˆ†æ”¯: ${{ github.ref_name }}
          - å¹³å°: Windows x64

          **ä¸‹è½½è¯´æ˜:**
          - ä¸‹è½½: `TomatoNovelDownloader-${{ steps.version.outputs.VERSION }}-windows.zip`
          - è§£å‹åè¿è¡Œ `.exe` æ–‡ä»¶å³å¯ä½¿ç”¨

          **æ›´æ–°å†…å®¹:**
          - åŸºäºæœ€æ–°ä»£ç è‡ªåŠ¨æ„å»º
          - ä¿®å¤APIæ‰¹æ¬¡é™åˆ¶é—®é¢˜ï¼ˆ30ç« /æ‰¹æ¬¡ï¼‰
          - ä¼˜åŒ–ç« èŠ‚å®Œæ•´æ€§éªŒè¯
          - æ”¹è¿›è‡ªåŠ¨æ›´æ–°ç³»ç»Ÿ

        files: release/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        

