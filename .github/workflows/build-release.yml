name: å¤šå¹³å°ç¼–è¯‘å¹¶å‘å¸ƒ
on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  build:
    strategy:
      matrix:
        include:
          # Windows å¹³å°
          - os: windows-latest
            platform: windows
            arch: x64
            python-arch: x64
            executable_ext: .exe
          - os: windows-latest
            platform: windows
            arch: x86
            python-arch: x86
            executable_ext: .exe
          # Windows ARM64 éœ€è¦ç‰¹æ®Šå¤„ç†ï¼ŒPyInstaller æ”¯æŒæœ‰é™
          
          # Linux å¹³å°
          - os: ubuntu-latest
            platform: linux
            arch: x64
            python-arch: x64
            executable_ext: ""
          - os: ubuntu-latest
            platform: linux
            arch: x86
            python-arch: x64  # ä½¿ç”¨x64æ„å»º32ä½
            executable_ext: ""
          - os: ubuntu-latest
            platform: linux
            arch: arm64
            python-arch: x64
            executable_ext: ""
          - os: ubuntu-latest
            platform: linux
            arch: armv7
            python-arch: x64
            executable_ext: ""
            
          # macOS å¹³å°
          - os: macos-latest
            platform: macos
            arch: x64
            python-arch: x64
            executable_ext: ""
          - os: macos-14  # Apple Silicon
            platform: macos
            arch: arm64
            python-arch: arm64
            executable_ext: ""
    
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 20

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        architecture: ${{ matrix.python-arch }}

    - name: Install system dependencies (Linux)
      if: matrix.platform == 'linux'
      run: |
        sudo apt-get update
        # Install tkinter and other GUI dependencies
        sudo apt-get install -y python3-tk python3-dev
        # Install other necessary system libraries
        sudo apt-get install -y libffi-dev libssl-dev

    - name: Install QEMU (Linux ARM builds)
      if: matrix.platform == 'linux' && (matrix.arch == 'arm64' || matrix.arch == 'armv7')
      run: |
        sudo apt-get install -y qemu-user-static binfmt-support

    - name: Install build tools (Linux 32-bit)
      if: matrix.platform == 'linux' && matrix.arch == 'x86'
      run: |
        sudo dpkg --add-architecture i386
        sudo apt-get update
        sudo apt-get install -y gcc-multilib g++-multilib

    - name: Install dependencies
      shell: bash
      run: |
        echo "Listing files in current directory:"
        ls -la
        python -m pip install --upgrade pip
        pip install pyinstaller
        # Use CI-specific requirements file to avoid tkinter installation issues
        if [ -f "requirements-ci.txt" ]; then
          echo "Using CI-specific dependencies file..."
          pip install -r requirements-ci.txt
        else
          echo "Using standard dependencies file..."
          pip install -r requirements.txt
        fi

    - name: Verify tkinter availability
      shell: bash
      run: |
        echo "Checking tkinter availability..."
        python -c "import tkinter; print('tkinter is available')" || {
          echo "tkinter not available, trying to install..."
          if [[ "${{ matrix.platform }}" == "linux" ]]; then
            sudo apt-get install -y python3-tk
          elif [[ "${{ matrix.platform }}" == "macos" ]]; then
            echo "macOS environment, tkinter should be included with Python"
          elif [[ "${{ matrix.platform }}" == "windows" ]]; then
            echo "Windows environment, tkinter should be included with Python"
          fi
          python -c "import tkinter; print('tkinter is now available')"
        }
        

        
    - name: Verify PyInstaller config file
      shell: bash
      run: |
        if [ -f "build_gui.spec" ]; then
          echo "build_gui.spec file exists"
          head -10 build_gui.spec || true
        else
          echo "build_gui.spec file not found"
          exit 1
        fi

    - name: Build executable
      shell: bash
      run: |
        # Set compilation options for different architectures
        EXTRA_ARGS=""

        # Linux ARM cross-compilation
        if [[ "${{ matrix.platform }}" == "linux" ]]; then
          case "${{ matrix.arch }}" in
            arm64)
              export PYINSTALLER_COMPILE_BOOTLOADER=1
              export CC=aarch64-linux-gnu-gcc
              export CXX=aarch64-linux-gnu-g++
              ;;
            armv7)
              export PYINSTALLER_COMPILE_BOOTLOADER=1
              export CC=arm-linux-gnueabihf-gcc
              export CXX=arm-linux-gnueabihf-g++
              ;;
            x86)
              export CFLAGS="-m32"
              export LDFLAGS="-m32"
              ;;
          esac
        fi

        pyinstaller build_gui.spec --clean --noconfirm $EXTRA_ARGS

    - name: Rename executable files
      shell: bash
      run: |
        if [ "${{ matrix.platform }}" = "windows" ]; then
          if [ -f "dist/TomatoNovelDownloader.exe" ]; then
            mv "dist/TomatoNovelDownloader.exe" "dist/TomatoNovelDownloader_windows_${{ matrix.arch }}.exe"
          fi
        else
          if [ -f "dist/TomatoNovelDownloader" ]; then
            mv "dist/TomatoNovelDownloader" "dist/TomatoNovelDownloader_${{ matrix.platform }}_${{ matrix.arch }}"
            chmod +x "dist/TomatoNovelDownloader_${{ matrix.platform }}_${{ matrix.arch }}"
          fi
        fi

    - name: List build results
      shell: bash
      run: |
        ls -la dist/

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: fanqie-downloader-${{ matrix.platform }}-${{ matrix.arch }}
        path: |
          dist/TomatoNovelDownloader_*
        retention-days: 30

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 20

    - name: Download all build artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Organize release files
      run: |
        mkdir -p release_files
        find artifacts -name "TomatoNovelDownloader_*" -type f -exec cp {} release_files/ \;
        ls -la release_files/

    - name: Generate version info
      id: version
      env:
        TZ: 'Asia/Shanghai'
      run: |
        version="v$(date +'%Y.%m.%d.%H%M')"
        echo "tag=$version" >> $GITHUB_OUTPUT
        git log --oneline -20 --pretty=format:"- %s" > commits.txt

    - name: Create release notes file
      env:
        TZ: 'Asia/Shanghai'
      run: |
        version="${{ steps.version.outputs.tag }}"
        
        # è·å–å„å›½æ—¶é—´
        china_time=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S CST')
        us_eastern_time=$(TZ='America/New_York' date +'%Y-%m-%d %H:%M:%S EST')
        us_pacific_time=$(TZ='America/Los_Angeles' date +'%Y-%m-%d %H:%M:%S PST')
        uk_time=$(TZ='Europe/London' date +'%Y-%m-%d %H:%M:%S GMT')
        france_time=$(TZ='Europe/Paris' date +'%Y-%m-%d %H:%M:%S CET')
        russia_time=$(TZ='Europe/Moscow' date +'%Y-%m-%d %H:%M:%S MSK')
        
        commit_content=$(cat commits.txt)
        
        cat > release_notes.md << EOF
        ## Fanqie Novel Downloader $version
        
        ### ğŸŒ å‘å¸ƒæ—¶é—´ / Release Time
        
        **å¤šå›½æ—¶é—´ / Countries Time:**
        - ğŸ‡¨ğŸ‡³ **ä¸­å›½ (åŒ—äº¬)**: $china_time
        - ğŸ‡ºğŸ‡¸ **ç¾å›½ (çº½çº¦)**: $us_eastern_time
        - ğŸ‡ºğŸ‡¸ **ç¾å›½ (æ´›æ‰çŸ¶)**: $us_pacific_time
        - ğŸ‡¬ğŸ‡§ **è‹±å›½ (ä¼¦æ•¦)**: $uk_time
        - ğŸ‡«ğŸ‡· **æ³•å›½ (å·´é»)**: $france_time
        - ğŸ‡·ğŸ‡º **ä¿„ç½—æ–¯ (è«æ–¯ç§‘)**: $russia_time
        
        ### ğŸ“ æ›´æ–°å†…å®¹ / Updates
        $commit_content
        
        ### ğŸ’» å¹³å°æ”¯æŒ / Platform Support
        
        æ­¤ç‰ˆæœ¬æ”¯æŒä»¥ä¸‹å¹³å°å’Œæ¶æ„ï¼š
        
        #### Windows
        - **FanqieDownloader_Debug_windows_x64.exe** - Windows 10/11 (64ä½) âœ…
        - **FanqieDownloader_Debug_windows_x86.exe** - Windows 7+ (32ä½) âœ…
        
        #### Linux
        - **FanqieDownloader_Debug_linux_x64** - Linux (64ä½ AMD/Intel) âœ…
        - **FanqieDownloader_Debug_linux_x86** - Linux (32ä½) âœ…
        - **FanqieDownloader_Debug_linux_arm64** - Linux ARM64 (æ ‘è“æ´¾4/5, ARMæœåŠ¡å™¨) ğŸ†•
        - **FanqieDownloader_Debug_linux_armv7** - Linux ARMv7 (æ ‘è“æ´¾2/3, 32ä½ARMè®¾å¤‡) ğŸ†•
        
        #### macOS
        - **FanqieDownloader_Debug_macos_x64** - macOS Intel (64ä½) âœ…
        - **FanqieDownloader_Debug_macos_arm64** - macOS Apple Silicon (M1/M2/M3) âœ…
        
        ### ğŸ“– ä½¿ç”¨è¯´æ˜ / Usage Instructions
        
        #### Windows ç”¨æˆ·ï¼š
        1. æ ¹æ®ç³»ç»Ÿä½æ•°ä¸‹è½½å¯¹åº”çš„ .exe æ–‡ä»¶
        2. åŒå‡»è¿è¡Œ
        3. å¦‚æœä¸ç¡®å®šç³»ç»Ÿä½æ•°ï¼Œå»ºè®®ä¸‹è½½ x86 ç‰ˆæœ¬ï¼ˆå…¼å®¹æ€§æ›´å¥½ï¼‰
        4. é¦–æ¬¡è¿è¡Œå¯èƒ½è¢«æ€æ¯’è½¯ä»¶æ‹¦æˆªï¼Œè¯·æ·»åŠ ä¿¡ä»»
        
        #### Linux ç”¨æˆ·ï¼š
        1. ä¸‹è½½å¯¹åº”æ¶æ„çš„äºŒè¿›åˆ¶æ–‡ä»¶
        2. æ·»åŠ æ‰§è¡Œæƒé™ï¼š\`chmod +x FanqieDownloader_Debug_linux_*\`
        3. è¿è¡Œï¼š\`./FanqieDownloader_Debug_linux_*\`
        4. æŸ¥çœ‹ç³»ç»Ÿæ¶æ„ï¼š\`uname -m\` (x86_64=x64, i686=x86, aarch64=arm64, armv7l=armv7)
        
        #### macOS ç”¨æˆ·ï¼š
        1. Intel Mac é€‰æ‹© x64 ç‰ˆæœ¬ï¼ŒApple Silicon (Mç³»åˆ—) é€‰æ‹© arm64 ç‰ˆæœ¬
        2. æ·»åŠ æ‰§è¡Œæƒé™ï¼š\`chmod +x FanqieDownloader_Debug_macos_*\`
        3. è¿è¡Œï¼š\`./FanqieDownloader_Debug_macos_*\`
        4. å¦‚è¢«ç³»ç»Ÿé˜»æ­¢ï¼Œè¯·åœ¨ç³»ç»Ÿåå¥½è®¾ç½® > å®‰å…¨æ€§ä¸éšç§ä¸­å…è®¸è¿è¡Œ
        5. æˆ–ä½¿ç”¨å‘½ä»¤ï¼š\`xattr -cr FanqieDownloader_Debug_macos_*\` æ¸…é™¤éš”ç¦»å±æ€§
        
        #### æ ‘è“æ´¾ç”¨æˆ·ï¼š
        - æ ‘è“æ´¾ 2/3 (32ä½ç³»ç»Ÿ): ä½¿ç”¨ armv7 ç‰ˆæœ¬
        - æ ‘è“æ´¾ 4/5 (64ä½ç³»ç»Ÿ): ä½¿ç”¨ arm64 ç‰ˆæœ¬
        - æŸ¥çœ‹æ¶æ„ï¼š\`dpkg --print-architecture\`
        
        ### âš ï¸ æ³¨æ„äº‹é¡¹ / Notes
        - æ§åˆ¶å°çª—å£ä¼šæ˜¾ç¤ºè¯¦ç»†çš„ä¸‹è½½è¿›åº¦å’Œé”™è¯¯ä¿¡æ¯
        - ARM ç‰ˆæœ¬é¦–æ¬¡æ”¯æŒï¼Œå¦‚é‡é—®é¢˜è¯·åé¦ˆ
        - æ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶éƒ½æ˜¯ç‹¬ç«‹è¿è¡Œçš„ï¼Œæ— éœ€å®‰è£… Python
        - å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·åœ¨ Issues ä¸­åé¦ˆå¹¶è¯´æ˜ï¼š
          - æ“ä½œç³»ç»Ÿç‰ˆæœ¬
          - è®¾å¤‡æ¶æ„
          - é”™è¯¯ä¿¡æ¯æˆªå›¾
        
        ### ğŸ”§ æ•…éšœæ’é™¤ / Troubleshooting
        
        **Linux æ‰§è¡Œæƒé™é—®é¢˜ï¼š**
        \`\`\`bash
        chmod +x FanqieDownloader_Debug_linux_*
        \`\`\`
        
        **macOS å®‰å…¨æç¤ºï¼š**
        \`\`\`bash
        xattr -cr FanqieDownloader_Debug_macos_*
        \`\`\`
        
        **æŸ¥çœ‹ç³»ç»Ÿæ¶æ„ï¼š**
        - Windows: \`wmic os get osarchitecture\`
        - Linux/macOS: \`uname -m\`
        
        ---
        
        ğŸ’¡ **æç¤º**: å¦‚æœä¸ç¡®å®šä¸‹è½½å“ªä¸ªç‰ˆæœ¬ï¼Œå¯ä»¥åœ¨ Issues ä¸­è¯¢é—®ï¼Œè¯´æ˜ä½ çš„è®¾å¤‡å‹å·å’Œæ“ä½œç³»ç»Ÿã€‚
        EOF

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.tag }}
        name: Fanqie Novel Downloader ${{ steps.version.outputs.tag }}
        body_path: release_notes.md
        files: |
          release_files/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
