name: è‡ªåŠ¨ç¼–è¯‘å‘å¸ƒ

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    strategy:
      fail-fast: false  # ä¸è¦å› ä¸ºä¸€ä¸ªå¹³å°å¤±è´¥å°±å–æ¶ˆå…¶ä»–å¹³å°
      matrix:
        include:
          - os: windows-latest
            executable_suffix: .exe
            artifact_name: windows
          - os: ubuntu-latest
            executable_suffix: ""
            artifact_name: linux
          - os: macos-latest
            executable_suffix: ""
            artifact_name: macos
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: ç”Ÿæˆç‰ˆæœ¬å·
      id: version
      run: |
        if [ "${{ runner.os }}" = "Windows" ]; then
          timestamp=$(powershell -Command "Get-Date -Format 'yyyy.MM.dd.HHmm'")
          commit_short="${{ github.sha }}"
          commit_short=${commit_short:0:7}
        else
          timestamp=$(date +"%Y.%m.%d.%H%M")
          commit_short="${{ github.sha }}"
          commit_short=${commit_short:0:7}
        fi
        version="$timestamp-$commit_short"
        echo "VERSION=$version" >> $GITHUB_OUTPUT
        echo "TIMESTAMP=$timestamp" >> $GITHUB_OUTPUT
        echo "Generated version: $version"
      shell: bash
      
    - name: æ›´æ–°ç‰ˆæœ¬ä¿¡æ¯
      run: |
        # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
        echo '# -*- coding: utf-8 -*-' > version.py
        echo '# ç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶ - ç”±GitHub Actionsè‡ªåŠ¨ç”Ÿæˆ' >> version.py
        echo '' >> version.py
        echo 'import os' >> version.py
        echo '' >> version.py
        echo 'VERSION="${{ steps.version.outputs.VERSION }}"' >> version.py
        echo 'BUILD_TIME="${{ steps.version.outputs.TIMESTAMP }}"' >> version.py
        echo 'COMMIT_HASH="${{ github.sha }}"' >> version.py
        echo 'BRANCH="${{ github.ref_name }}"' >> version.py
        echo 'IS_COMPILED_VERSION = True' >> version.py
        echo '' >> version.py
        echo 'def get_version_info():' >> version.py
        echo '    return {' >> version.py
        echo "        'version': VERSION," >> version.py
        echo "        'build_time': BUILD_TIME," >> version.py
        echo "        'commit_hash': COMMIT_HASH," >> version.py
        echo "        'branch': BRANCH," >> version.py
        echo "        'is_compiled': IS_COMPILED_VERSION" >> version.py
        echo '    }' >> version.py
        echo '' >> version.py
        echo 'def get_version_string():' >> version.py
        echo '    return f"v{VERSION}"' >> version.py
        echo '    ' >> version.py
        echo 'def is_development_version():' >> version.py
        echo '    """åˆ¤æ–­æ˜¯å¦ä¸ºå¼€å‘ç‰ˆæœ¬"""' >> version.py
        echo '    return False  # ç¼–è¯‘ç‰ˆæœ¬æ€»æ˜¯è¿”å›False' >> version.py
        echo '    ' >> version.py
        echo 'def get_base_version():' >> version.py
        echo '    """è·å–åŸºç¡€ç‰ˆæœ¬å·ï¼ˆä¸åŒ…å«commit hashï¼‰ç”¨äºç‰ˆæœ¬æ¯”è¾ƒ"""' >> version.py
        echo "    if '-' in VERSION:" >> version.py
        echo "        return VERSION.split('-')[0]" >> version.py
        echo '    return VERSION' >> version.py

        echo "Version file created:"
        cat version.py
      shell: bash
      
    - name: å®‰è£…ç³»ç»Ÿä¾èµ–
      if: runner.os != 'Windows'
      run: |
        if [ "${{ runner.os }}" = "Linux" ]; then
          sudo apt-get update
          sudo apt-get install -y python3-tk tk-dev libxml2-dev libxslt1-dev python3-dev
        elif [ "${{ runner.os }}" = "macOS" ]; then
          brew update || true
          brew install tcl-tk libxml2 libxslt || true
        fi
      shell: bash

    - name: ç¼“å­˜Pythonä¾èµ–
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: å®‰è£…Pythonä¾èµ–
      run: |
        python -m pip install --upgrade pip
        echo "å®‰è£…requirements.txtä¸­çš„ä¾èµ–..."
        
        # å°è¯•å®‰è£…æ‰€æœ‰ä¾èµ–ï¼Œå¦‚æœå¤±è´¥åˆ™é€ä¸ªå®‰è£…
        if ! pip install -r requirements.txt; then
          echo "æ‰¹é‡å®‰è£…å¤±è´¥ï¼Œå°è¯•é€ä¸ªå®‰è£…..."
          pip install requests>=2.28.0,<3.0.0
          pip install Pillow>=9.0.0,<11.0.0
          pip install ebooklib>=0.18,<0.19
          pip install fake-useragent>=1.5.0,<2.0.0
          pip install tqdm>=4.65.0,<5.0.0
          pip install beautifulsoup4>=4.12.0,<5.0.0
          pip install urllib3>=1.26.0,<3.0.0
          # å¯é€‰ä¾èµ–
          pip install pillow-heif>=1.0.0 || echo "pillow-heifå®‰è£…å¤±è´¥ï¼Œä½†è¿™æ˜¯å¯é€‰çš„"
        fi
        
        echo "å®‰è£…PyInstaller..."
        pip install pyinstaller
        
        echo "éªŒè¯å…³é”®ä¾èµ–æ˜¯å¦å®‰è£…æˆåŠŸ..."
        python -c "import bs4; print('âœ“ beautifulsoup4/bs4 å®‰è£…æˆåŠŸ')"
        python -c "import fake_useragent; print('âœ“ fake_useragent å®‰è£…æˆåŠŸ')"
        python -c "import tqdm; print('âœ“ tqdm å®‰è£…æˆåŠŸ')"
        python -c "import requests; print('âœ“ requests å®‰è£…æˆåŠŸ')"
        python -c "import PIL; print('âœ“ Pillow å®‰è£…æˆåŠŸ')"
        python -c "import ebooklib; print('âœ“ ebooklib å®‰è£…æˆåŠŸ')"
        echo "æ‰€æœ‰ä¾èµ–å®‰è£…éªŒè¯å®Œæˆï¼"
      shell: bash

    - name: æµ‹è¯•æ¨¡å—å¯¼å…¥
      run: |
        echo "è¿è¡Œå®Œæ•´çš„æ¨¡å—å¯¼å…¥æµ‹è¯•..."
        if [ -f "test_imports.py" ]; then
          python test_imports.py
        else
          echo "âš ï¸ test_imports.py ä¸å­˜åœ¨ï¼Œè·³è¿‡æ¨¡å—å¯¼å…¥æµ‹è¯•"
          echo "æ‰‹åŠ¨æµ‹è¯•å…³é”®æ¨¡å—..."
          python -c "import requests, PIL, ebooklib, bs4, fake_useragent, tqdm, urllib3; print('âœ… æ‰€æœ‰å…³é”®æ¨¡å—å¯¼å…¥æˆåŠŸ')"
        fi
      shell: bash
        
    - name: æ£€æŸ¥æ–‡ä»¶å­˜åœ¨æ€§
      run: |
        echo "å½“å‰ç›®å½•æ–‡ä»¶åˆ—è¡¨:"
        ls -la
        echo "æŸ¥æ‰¾Pythonæ–‡ä»¶:"
        find . -name "*.py" -type f
        echo "æ£€æŸ¥gui.pyæ˜¯å¦å­˜åœ¨:"
        if [ -f "gui.py" ]; then
          echo "âœ… gui.py å­˜åœ¨"
        else
          echo "âŒ gui.py ä¸å­˜åœ¨"
        fi
      shell: bash

    - name: ç¼–è¯‘å¯æ‰§è¡Œæ–‡ä»¶
      run: |
        echo "å¼€å§‹ç¼–è¯‘å¯æ‰§è¡Œæ–‡ä»¶..."
        
        # æ£€æŸ¥æ˜¯å¦å­˜åœ¨build.specæ–‡ä»¶
        if [ -f "build.spec" ]; then
          echo "âœ… ä½¿ç”¨build.specé…ç½®æ–‡ä»¶ç¼–è¯‘"
          pyinstaller build.spec --clean --noconfirm
        else
          echo "âš ï¸ æœªæ‰¾åˆ°build.specï¼Œä½¿ç”¨é»˜è®¤é…ç½®ç¼–è¯‘"
          pyinstaller --onefile --windowed \
            --name="TomatoNovelDownloader" \
            --add-data="version.py:." \
            --hidden-import=bs4 \
            --hidden-import=beautifulsoup4 \
            --hidden-import=fake_useragent \
            --hidden-import=tqdm \
            --hidden-import=requests \
            --hidden-import=urllib3 \
            --hidden-import=ebooklib \
            --hidden-import=PIL \
            --hidden-import=PIL.Image \
            --hidden-import=PIL.ImageTk \
            gui.py
        fi

        # æ£€æŸ¥ç¼–è¯‘ç»“æœ
        echo "ç¼–è¯‘å®Œæˆï¼Œæ£€æŸ¥è¾“å‡ºï¼š"
        ls -la dist/
        
        # éªŒè¯å¯æ‰§è¡Œæ–‡ä»¶æ˜¯å¦åˆ›å»ºæˆåŠŸ
        if [ "${{ runner.os }}" = "Windows" ]; then
          if [ -f "dist/TomatoNovelDownloader.exe" ]; then
            echo "âœ… Windowså¯æ‰§è¡Œæ–‡ä»¶ç¼–è¯‘æˆåŠŸ"
            file dist/TomatoNovelDownloader.exe || echo "æ–‡ä»¶ä¿¡æ¯è·å–å¤±è´¥"
          else
            echo "âŒ Windowså¯æ‰§è¡Œæ–‡ä»¶ç¼–è¯‘å¤±è´¥"
            exit 1
          fi
        else
          if [ -f "dist/TomatoNovelDownloader" ]; then
            echo "âœ… Unixå¯æ‰§è¡Œæ–‡ä»¶ç¼–è¯‘æˆåŠŸ"
            file dist/TomatoNovelDownloader || echo "æ–‡ä»¶ä¿¡æ¯è·å–å¤±è´¥"
            chmod +x dist/TomatoNovelDownloader
          else
            echo "âŒ Unixå¯æ‰§è¡Œæ–‡ä»¶ç¼–è¯‘å¤±è´¥"
            exit 1
          fi
        fi
      shell: bash
      
    - name: åˆ›å»ºå‘å¸ƒåŒ…
      run: |
        version="${{ steps.version.outputs.VERSION }}"
        artifact_name="${{ matrix.artifact_name }}"

        # åˆ›å»ºå‘å¸ƒç›®å½•ç»“æ„
        mkdir -p release/TomatoNovelDownloader-$version-$artifact_name

        # æ ¹æ®å¹³å°å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
        if [ "${{ runner.os }}" = "Windows" ]; then
          # Windowså¹³å°
          if [ -f "dist/TomatoNovelDownloader.exe" ]; then
            cp dist/TomatoNovelDownloader.exe "release/TomatoNovelDownloader-$version-$artifact_name/"
            echo "âœ… Windowså¯æ‰§è¡Œæ–‡ä»¶å·²å¤åˆ¶"
          else
            echo "âŒ æœªæ‰¾åˆ°Windowså¯æ‰§è¡Œæ–‡ä»¶"
            ls -la dist/
            exit 1
          fi
        else
          # Linux/macOSå¹³å°
          if [ -f "dist/TomatoNovelDownloader" ]; then
            cp dist/TomatoNovelDownloader "release/TomatoNovelDownloader-$version-$artifact_name/"
            chmod +x "release/TomatoNovelDownloader-$version-$artifact_name/TomatoNovelDownloader"
            echo "âœ… Unixå¯æ‰§è¡Œæ–‡ä»¶å·²å¤åˆ¶"
          else
            echo "âŒ æœªæ‰¾åˆ°Unixå¯æ‰§è¡Œæ–‡ä»¶"
            ls -la dist/
            exit 1
          fi
        fi

        # åˆ›å»ºå‹ç¼©åŒ…
        cd release
        if [ "${{ runner.os }}" = "Windows" ]; then
          # Windows ä½¿ç”¨ PowerShell è‡ªå¸¦çš„ Compress-Archive
          powershell -Command "Compress-Archive -Path 'TomatoNovelDownloader-$version-$artifact_name' -DestinationPath 'TomatoNovelDownloader-$version-$artifact_name.zip'"
        else
          # Linux/macOS ä½¿ç”¨ zip å‘½ä»¤
          zip -r "TomatoNovelDownloader-$version-$artifact_name.zip" "TomatoNovelDownloader-$version-$artifact_name"
        fi
        cd ..

        # åˆ›å»ºæ›´æ–°ä¿¡æ¯æ–‡ä»¶
        timestamp="${{ steps.version.outputs.TIMESTAMP }}"
        repository="${{ github.repository }}"
        commit_hash="${{ github.sha }}"
        branch_name="${{ github.ref_name }}"
        
        echo '{' > "release/update_info_$artifact_name.json"
        echo "  \"version\": \"$version\"," >> "release/update_info_$artifact_name.json"
        echo "  \"platform\": \"$artifact_name\"," >> "release/update_info_$artifact_name.json"
        echo "  \"build_time\": \"$timestamp\"," >> "release/update_info_$artifact_name.json"
        echo "  \"download_url\": \"https://github.com/$repository/releases/download/v$version/TomatoNovelDownloader-$version-$artifact_name.zip\"," >> "release/update_info_$artifact_name.json"
        echo "  \"changelog\": \"è‡ªåŠ¨æ„å»ºç‰ˆæœ¬ $version\"," >> "release/update_info_$artifact_name.json"
        echo "  \"commit\": \"$commit_hash\"," >> "release/update_info_$artifact_name.json"
        echo "  \"branch\": \"$branch_name\"" >> "release/update_info_$artifact_name.json"
        echo '}' >> "release/update_info_$artifact_name.json"

        echo "å‘å¸ƒåŒ…åˆ›å»ºå®Œæˆï¼š"
        ls -la release/
        echo "å‹ç¼©åŒ…å†…å®¹ï¼š"
        if [ "${{ runner.os }}" = "Windows" ]; then
          powershell -Command "Expand-Archive -Path 'release/TomatoNovelDownloader-$version-$artifact_name.zip' -DestinationPath 'temp-check' -Force; Get-ChildItem -Recurse temp-check"
        else
          unzip -l "release/TomatoNovelDownloader-$version-$artifact_name.zip"
        fi
      shell: bash
      
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: TomatoNovelDownloader-${{ steps.version.outputs.VERSION }}-${{ matrix.artifact_name }}
        path: release/
        
  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    permissions:
      contents: write
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        path: artifacts/

    - name: è·å–æœ€æ–°çš„ç‰ˆæœ¬å·
      id: get_version
      run: |
        # ä»ä¸‹è½½çš„æ„å»ºäº§ç‰©ä¸­æå–ç‰ˆæœ¬å·
        version_file=$(find artifacts/ -name "update_info_*.json" | head -n 1)
        if [ -n "$version_file" ]; then
          version=$(jq -r '.version' "$version_file")
          timestamp=$(jq -r '.build_time' "$version_file")
          echo "VERSION=$version" >> $GITHUB_OUTPUT
          echo "TIMESTAMP=$timestamp" >> $GITHUB_OUTPUT
          echo "Found version: $version"
        else
          # fallbackæ–¹æ¡ˆ
          timestamp=$(date +"%Y.%m.%d.%H%M")
          commit_short="${{ github.sha }}"
          commit_short=${commit_short:0:7}
          version="$timestamp-$commit_short"
          echo "VERSION=$version" >> $GITHUB_OUTPUT
          echo "TIMESTAMP=$timestamp" >> $GITHUB_OUTPUT
          echo "Fallback version: $version"
        fi

    - name: æ•´ç†å‘å¸ƒæ–‡ä»¶
      run: |
        mkdir -p release
        find artifacts/ -name "*.zip" -exec cp {} release/ \;
        find artifacts/ -name "*.json" -exec cp {} release/ \;
        ls -la release/

    - name: åˆ›å»ºRelease
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ steps.get_version.outputs.VERSION }}
        name: TomatoNovelDownloader v${{ steps.get_version.outputs.VERSION }}
        body: |
          ## ğŸš€ è‡ªåŠ¨æ„å»ºç‰ˆæœ¬ ${{ steps.get_version.outputs.VERSION }}

          **æ„å»ºä¿¡æ¯:**
          - æ„å»ºæ—¶é—´: ${{ steps.get_version.outputs.TIMESTAMP }}
          - æäº¤å“ˆå¸Œ: ${{ github.sha }}
          - åˆ†æ”¯: ${{ github.ref_name }}

          **ä¸‹è½½è¯´æ˜:**
          - Windows: `TomatoNovelDownloader-${{ steps.get_version.outputs.VERSION }}-windows.zip`
          - Linux: `TomatoNovelDownloader-${{ steps.get_version.outputs.VERSION }}-linux.zip`
          - macOS: `TomatoNovelDownloader-${{ steps.get_version.outputs.VERSION }}-macos.zip`

          **æ›´æ–°å†…å®¹:**
          ${{ github.event.head_commit.message }}

        files: release/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}