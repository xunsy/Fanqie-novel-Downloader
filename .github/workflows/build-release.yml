name: å¤šå¹³å°ç¼–è¯‘å¹¶å‘å¸ƒ

on:
  push:
    branches: [main, master]
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  build:
    outputs:
      build_ver: ${{ steps.genver.outputs.build_ver }}
    strategy:
      fail-fast: false # <--- é‡è¦ï¼šå…è®¸å…¶ä»–æ„å»ºç»§ç»­ï¼Œå³ä½¿ä¸€ä¸ªå¤±è´¥
      matrix:
        include:
          # Windows
          - os: windows-latest
            platform: windows
            arch: x64
            python-arch: x64
            executable_ext: .exe
          - os: windows-latest
            platform: windows
            arch: x86
            python-arch: x86 # ç¡®ä¿è¿™æ˜¯ä½ æƒ³è¦çš„32ä½Python
            executable_ext: .exe
          # Linux
          - os: ubuntu-latest
            platform: linux
            arch: x64
            python-arch: x64
            executable_ext: ""
          - os: ubuntu-latest
            platform: linux
            arch: x86
            python-arch: x64 # ä½¿ç”¨64ä½Pythonæ„å»º32ä½ç›®æ ‡
            executable_ext: ""
          - os: ubuntu-latest
            platform: linux
            arch: arm64
            python-arch: x64 # ä½¿ç”¨64ä½Pythonäº¤å‰ç¼–è¯‘ARM64
            executable_ext: ""
          - os: ubuntu-latest
            platform: linux
            arch: armv7
            python-arch: x64 # ä½¿ç”¨64ä½Pythonäº¤å‰ç¼–è¯‘ARMv7
            executable_ext: ""
          # macOS
          - os: macos-latest # é€šå¸¸æ˜¯ Intel x64
            platform: macos
            arch: x64
            python-arch: x64
            executable_ext: ""
          - os: macos-14 # é€šå¸¸æ˜¯ Apple Silicon ARM64
            platform: macos
            arch: arm64
            python-arch: arm64
            executable_ext: ""
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate build version
        id: genver
        shell: bash
        run: |
          BUILD_VER="$(date -u +'%Y.%m.%d.%H%M')"
          echo "build_ver=$BUILD_VER" >> $GITHUB_OUTPUT
          # æ›´æ–°æ–°çš„æ¨¡å—åŒ–ç»“æ„ä¸­çš„ç‰ˆæœ¬æ–‡ä»¶
          sed -i "s/APP_VERSION = \".*\"/APP_VERSION = \"$BUILD_VER\"/" src/config/constants.py
          echo "BUILD_VER=$BUILD_VER" >> $GITHUB_ENV

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          architecture: ${{ matrix.python-arch }}

      - name: Install Linux dependencies
        if: ${{ matrix.platform == 'linux' }}
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3-tk \
            python3-dev \
            libffi-dev \
            libssl-dev

      - name: Setup QEMU (Linux ARM builds)
        if: ${{ matrix.platform == 'linux' && (matrix.arch == 'arm64' || matrix.arch == 'armv7') }}
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-user-static binfmt-support

      - name: Install 32-bit toolchain (Linux x86)
        if: ${{ matrix.platform == 'linux' && matrix.arch == 'x86' }}
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update
          sudo apt-get install -y gcc-multilib g++-multilib

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          # å®‰è£…é¡¹ç›®ä¾èµ–
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt -vvv
          else
            echo "Warning: No requirements.txt found."
          fi
        shell: bash # ç¡®ä¿åœ¨ Windows ä¸Šä¹Ÿèƒ½ç”¨ [ -f ... ]

      - name: Build executable
        # é‡è¦: åœ¨Windowsä¸Šä½¿ç”¨bashè¯­æ³•æ—¶ï¼Œéœ€è¦æŒ‡å®š shell: bash
        shell: bash
        run: |
          EXTRA_ARGS="" # å¦‚æœä¸éœ€è¦ï¼Œå¯ä»¥ç§»é™¤è¿™è¡Œ
          PYINSTALLER_CMD="pyinstaller --log-level DEBUG" # æ·»åŠ è¯¦ç»†æ—¥å¿—
          SPEC_FILE=build_gui.spec  # ä½¿ç”¨æ¨¡å—åŒ–é‡æ„åçš„GUI spec

          # macOS specific build
          if [[ "${{ matrix.platform }}" == "macos" ]]; then
            if [[ "${{ matrix.arch }}" == "x64" ]]; then
              echo "â–„â–„â–„ Building macOS x64 (Intel) â–„â–„â–„"
              arch -x86_64 $PYINSTALLER_CMD $SPEC_FILE --clean --noconfirm $EXTRA_ARGS
            else
              echo "â–„â–„â–„ Building macOS arm64 (Apple Silicon) â–„â–„â–„"
              $PYINSTALLER_CMD $SPEC_FILE --clean --noconfirm $EXTRA_ARGS
            fi

          # Linux specific build
          elif [[ "${{ matrix.platform }}" == "linux" ]]; then
            case "${{ matrix.arch }}" in
              arm64)
                echo "â–„â–„â–„ Building Linux arm64 â–„â–„â–„"
                export PYINSTALLER_COMPILE_BOOTLOADER=1
                export CC=aarch64-linux-gnu-gcc
                export CXX=aarch64-linux-gnu-g++
                # å¯èƒ½éœ€è¦ä¸ºäº¤å‰ç¼–è¯‘å®‰è£…ç›®æ ‡æ¶æ„çš„Pythonå¤´æ–‡ä»¶å’Œåº“
                # sudo apt-get install -y python3-dev-arm64 libssl-dev:arm64 libffi-dev:arm64
                ;;
              armv7)
                echo "â–„â–„â–„ Building Linux armv7 â–„â–„â–„"
                export PYINSTALLER_COMPILE_BOOTLOADER=1
                export CC=arm-linux-gnueabihf-gcc
                export CXX=arm-linux-gnueabihf-g++
                # å¯èƒ½éœ€è¦ä¸ºäº¤å‰ç¼–è¯‘å®‰è£…ç›®æ ‡æ¶æ„çš„Pythonå¤´æ–‡ä»¶å’Œåº“
                # sudo apt-get install -y python3-dev-armhf libssl-dev:armhf libffi-dev:armhf
                ;;
              x86)
                echo "â–„â–„â–„ Building Linux x86 â–„â–„â–„"
                export CFLAGS="-m32"
                export LDFLAGS="-m32"
                # å¦‚æœPythonæ˜¯64ä½çš„ï¼ŒPyInstallerå¯èƒ½ä»éœ€è¦32ä½Pythonå¼€å‘æ–‡ä»¶
                # sudo apt-get install -y python3-dev:i386 libssl-dev:i386 libffi-dev:i386
                ;;
              *)
                echo "â–„â–„â–„ Building Linux ${{ matrix.arch }} â–„â–„â–„"
                ;;
            esac
            $PYINSTALLER_CMD $SPEC_FILE --clean --noconfirm $EXTRA_ARGS

          # Windows and others
          else
            echo "â–„â–„â–„ Building ${{ matrix.platform }} ${{ matrix.arch }} â–„â–„â–„"
            $PYINSTALLER_CMD $SPEC_FILE --clean --noconfirm $EXTRA_ARGS
          fi

      - name: Rename artifacts
        # é‡è¦: åœ¨Windowsä¸Šä½¿ç”¨bashè¯­æ³•æ—¶ï¼Œéœ€è¦æŒ‡å®š shell: bash
        shell: bash
        run: |
          SOURCE_PATH="dist/TomatoNovelDownloader" # ç¡®ä¿è¿™ä¸ªè·¯å¾„å’Œä½ çš„ .spec æ–‡ä»¶è¾“å‡ºä¸€è‡´
          DEST_PREFIX="FanqieDownloader_Debug"

          if [[ ! -d "dist" ]]; then
            echo "Error: dist directory not found. PyInstaller build might have failed."
            exit 1
          fi

          if [[ "${{ matrix.platform }}" == "windows" ]]; then
            if [[ -f "${SOURCE_PATH}.exe" ]]; then
              mv "${SOURCE_PATH}.exe" "dist/${DEST_PREFIX}_windows_${{ matrix.arch }}.exe"
            else
              echo "Error: Expected executable ${SOURCE_PATH}.exe not found in dist/ for Windows."
              ls -R dist/ # åˆ—å‡ºdistç›®å½•å†…å®¹å¸®åŠ©è°ƒè¯•
              exit 1
            fi
          else
            if [[ -f "${SOURCE_PATH}" ]]; then
              mv "${SOURCE_PATH}" "dist/${DEST_PREFIX}_${{ matrix.platform }}_${{ matrix.arch }}"
              chmod +x "dist/${DEST_PREFIX}_${{ matrix.platform }}_${{ matrix.arch }}"
            else
              echo "Error: Expected executable ${SOURCE_PATH} not found in dist/ for ${{ matrix.platform }}."
              ls -R dist/ # åˆ—å‡ºdistç›®å½•å†…å®¹å¸®åŠ©è°ƒè¯•
              exit 1
            fi
          fi

      - name: Verify binary and list dist
        # é‡è¦: åœ¨Windowsä¸Šä½¿ç”¨bashè¯­æ³•æ—¶ï¼Œéœ€è¦æŒ‡å®š shell: bash
        shell: bash
        run: |
          echo "--- Listing dist directory ---"
          ls -lhR dist/
          echo "--- Verifying binary (if not Windows) ---"
          if [[ "${{ matrix.platform }}" != "windows" ]]; then
            file "dist/FanqieDownloader_Debug_${{ matrix.platform }}_${{ matrix.arch }}"
          else
            echo "Skipping 'file' command on Windows. Checking existence:"
            if [[ -f "dist/FanqieDownloader_Debug_windows_${{ matrix.arch }}.exe" ]]; then
              echo "Windows executable exists."
            else
              echo "Windows executable NOT found!"
              exit 1 # Or handle as a warning
            fi
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: fanqie-${{ matrix.platform }}-${{ matrix.arch }}
          path: |
            dist/FanqieDownloader_Debug_${{ matrix.platform }}_${{ matrix.arch }}*
            !dist/*.dmg  # æ’é™¤ä¸å¿…è¦çš„æ–‡ä»¶ (ç¡®ä¿è·¯å¾„æ­£ç¡®)

  release:
    needs: [build]
    runs-on: ubuntu-latest
    env:
      BUILD_VER: ${{ needs.build.outputs.build_ver }}
    # ä»…åœ¨ä¸»åˆ†æ”¯æ¨é€æ—¶è¿è¡Œï¼Œå¹¶ä¸”æ‰€æœ‰build jobéƒ½æˆåŠŸ (needséšå¼å¤„ç†æˆåŠŸ)
    if: ${{ success() && github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–æ‰€æœ‰å†å²è®°å½•ä»¥ä¾¿ç”Ÿæˆå®Œæ•´çš„changelog

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          # pattern: fanqie-* # é»˜è®¤ä¸‹è½½æ‰€æœ‰ï¼Œå¯ä»¥ä¸æŒ‡å®špattern
          # merge-multiple: true # å¦‚æœv4æ”¯æŒï¼Œå¯ä»¥å°†æ‰€æœ‰artifactå†…å®¹åˆå¹¶åˆ°ä¸€ä¸ªç›®å½•ï¼Œç®€åŒ–åç»­æ“ä½œ

      - name: Prepare release assets
        id: prepare
        run: |
          # åˆ›å»ºå¹²å‡€çš„å‘å¸ƒç›®å½•
          mkdir -p release_files

          # æ•´ç†æ‰€æœ‰å¹³å°çš„å¯æ‰§è¡Œæ–‡ä»¶
          # download-artifact@v4 ä¼šå°†æ¯ä¸ª artifact æ”¾åˆ°ä»¥å…¶ name å‘½åçš„å­ç›®å½•ä¸­
          echo "Looking for artifacts in ./artifacts..."
          find artifacts/ -type f -name "FanqieDownloader_Debug_*" -print -exec cp {} release_files/ \;

          if [ -z "$(ls -A release_files)" ]; then
            echo "No artifacts found in release_files. Listing downloaded artifacts:"
            ls -R artifacts/
            exit 1
          fi
          echo "Files in release_files:"
          ls -l release_files/

          # ä½¿ç”¨æ„å»ºé˜¶æ®µç”Ÿæˆçš„ç‰ˆæœ¬å·
          RELEASE_TAG="v${BUILD_VER}"
          echo "Generated release tag: $RELEASE_TAG"

          # å†™å…¥GitHub Actionså˜é‡
          echo "tag=$RELEASE_TAG" >> "$GITHUB_OUTPUT"

          # ç”Ÿæˆæ›´æ–°æ—¥å¿—ï¼ˆæœ€è¿‘20æ¡æäº¤ï¼‰
          git log -20 --date=format:'%Y-%m-%d' --pretty=format:"- %ad (%h): %s" > release_files/changelog.txt
        shell: bash

      - name: Generate release notes
        run: |
          cat << EOF > release_notes.md
          # ğŸ… ç•ªèŒ„å°è¯´ä¸‹è½½å™¨ v2.0 - æ¨¡å—åŒ–é‡æ„ç‰ˆæœ¬ ${{ steps.prepare.outputs.tag }}

          ## ğŸ‰ é‡å¤§æ›´æ–°ï¼šæ¨¡å—åŒ–é‡æ„å®Œæˆï¼

          è¿™æ˜¯å…¨æ–°çš„æ¨¡å—åŒ–é‡æ„ç‰ˆæœ¬ï¼Œå…·æœ‰æ›´å¥½çš„ä»£ç ç»„ç»‡å’Œç»´æŠ¤æ€§ï¼š
          - ğŸ—ï¸ åˆ†å±‚æ¶æ„è®¾è®¡ (æ ¸å¿ƒå±‚ã€æœåŠ¡å±‚ã€UIå±‚ã€å·¥å…·å±‚)
          - ğŸ”§ å•ä¸€èŒè´£åŸåˆ™ï¼Œæ¾è€¦åˆè®¾è®¡
          - âš™ï¸ ç»Ÿä¸€é…ç½®ç®¡ç†ç³»ç»Ÿ
          - ğŸ“ å®Œå–„çš„æ—¥å¿—ç³»ç»Ÿ
          - ğŸ›¡ï¸ ä¼˜åŒ–çš„é”™è¯¯å¤„ç†

          ### ğŸ”§ æ”¯æŒå¹³å°
          - **macOS**
            - Intel 64-bit: \`FanqieDownloader_Debug_macos_x64\`
            - Apple Silicon: \`FanqieDownloader_Debug_macos_arm64\`
          - **Windows**
            - 64-bit: \`FanqieDownloader_Debug_windows_x64.exe\`
            - 32-bit: \`FanqieDownloader_Debug_windows_x86.exe\`
          - **Linux**
            - x64: \`FanqieDownloader_Debug_linux_x64\`
            - x86: \`FanqieDownloader_Debug_linux_x86\`
            - arm64: \`FanqieDownloader_Debug_linux_arm64\`
            - armv7: \`FanqieDownloader_Debug_linux_armv7\`

          ### ğŸ“„ æ›´æ–°æ—¥å¿—
          $(cat release_files/changelog.txt)
          EOF
        shell: bash

      - name: Create GitHub release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.prepare.outputs.tag }}
          name: "ç•ªèŒ„å°è¯´ä¸‹è½½å™¨ ${{ steps.prepare.outputs.tag }}"
          body_path: release_notes.md
          files: |
            release_files/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
