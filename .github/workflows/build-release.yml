name: ç¼–è¯‘å¹¶å‘å¸ƒexe

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 20  # è·å–æœ€è¿‘20æ¬¡æäº¤
    
    - name: è®¾ç½®Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: å®‰è£…ä¾èµ–
      shell: pwsh
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        
        # å®‰è£…é¡¹ç›®ä¾èµ–
        $packages = @(
          "customtkinter>=5.2.0",
          "requests>=2.31.0",
          "beautifulsoup4>=4.12.0",
          "tqdm>=4.65.0",
          "stem>=1.8.0",
          "fake-useragent>=1.4.0",
          "pycryptodome>=3.18.0",
          "ebooklib>=0.18",
          "lxml>=4.9.0",
          "urllib3>=2.0.0",
          "PySocks>=1.7.1"
        )
        
        foreach ($package in $packages) {
          pip install $package
        }
    
    - name: éªŒè¯PyInstalleré…ç½®æ–‡ä»¶
      shell: pwsh
      run: |
        # æ£€æŸ¥build_console.specæ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if (Test-Path "build_console.spec") {
          echo "âœ… build_console.spec æ–‡ä»¶å­˜åœ¨"
          Get-Content "build_console.spec" | Select-Object -First 10
        } else {
          echo "âŒ build_console.spec æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        }
    
    - name: ç¼–è¯‘exe
      shell: pwsh
      run: |
        # ç¼–è¯‘è°ƒè¯•ç‰ˆæœ¬ï¼ˆå¸¦æ§åˆ¶å°çª—å£ï¼‰
        pyinstaller build_console.spec --clean --noconfirm
    
    - name: ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯
      id: version
      shell: pwsh
      run: |
        $version = "v$(Get-Date -Format 'yyyy.MM.dd.HHmm')"
        echo "tag=$version" >> $env:GITHUB_OUTPUT
        
        # è·å–æäº¤ä¿¡æ¯
        $commits = git log --oneline -20 --pretty=format:"- %s"
        $body = @"
## ğŸ… ç•ªèŒ„å°è¯´ä¸‹è½½å™¨ $version

### ğŸ“… å‘å¸ƒæ—¶é—´
$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')

### ğŸ“ æ›´æ–°å†…å®¹
$commits

### ğŸ’¾ ä½¿ç”¨è¯´æ˜

#### ğŸ“¦ ç‰ˆæœ¬è¯´æ˜ï¼š
- **ç•ªèŒ„å°è¯´ä¸‹è½½å™¨_è°ƒè¯•ç‰ˆ.exe** - å¸¦æ§åˆ¶å°çª—å£ç‰ˆæœ¬ï¼Œä¾¿äºæŸ¥çœ‹è¿è¡Œä¿¡æ¯å’Œè°ƒè¯•

#### ğŸš€ ä½¿ç”¨æ–¹æ³•ï¼š
1. ä¸‹è½½exeæ–‡ä»¶
2. åŒå‡»è¿è¡Œå³å¯ä½¿ç”¨
3. æ”¯æŒ Windows 10+ ç³»ç»Ÿ
4. æ§åˆ¶å°çª—å£ä¼šæ˜¾ç¤ºè¯¦ç»†çš„è¿è¡Œä¿¡æ¯

### âš ï¸ æ³¨æ„äº‹é¡¹
- é¦–æ¬¡è¿è¡Œå¯èƒ½è¢«æ€æ¯’è½¯ä»¶æ‹¦æˆªï¼Œè¯·æ·»åŠ ä¿¡ä»»
- æ§åˆ¶å°çª—å£ä¼šæ˜¾ç¤ºè¯¦ç»†çš„ä¸‹è½½è¿›åº¦å’Œé”™è¯¯ä¿¡æ¯
- å¦‚æœ‰é—®é¢˜è¯·åœ¨ Issues ä¸­åé¦ˆ
"@
        
        $body | Out-File -FilePath "release_notes.md" -Encoding UTF8
    
    - name: åˆ›å»ºRelease
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.tag }}
        name: ç•ªèŒ„å°è¯´ä¸‹è½½å™¨ ${{ steps.version.outputs.tag }}
        body_path: release_notes.md
        files: |
          dist/ç•ªèŒ„å°è¯´ä¸‹è½½å™¨_è°ƒè¯•ç‰ˆ.exe
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
