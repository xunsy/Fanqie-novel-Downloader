name: ç¼–è¯‘å¹¶å‘å¸ƒexe

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 20  # è·å–æœ€è¿‘20æ¬¡æäº¤
    
    - name: è®¾ç½®Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: å®‰è£…ä¾èµ–
      shell: pwsh
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        
        # å®‰è£…é¡¹ç›®ä¾èµ–
        $packages = @(
          "customtkinter>=5.2.0",
          "requests>=2.31.0",
          "beautifulsoup4>=4.12.0",
          "tqdm>=4.65.0",
          "stem>=1.8.0",
          "fake-useragent>=1.4.0",
          "pycryptodome>=3.18.0",
          "ebooklib>=0.18",
          "lxml>=4.9.0",
          "urllib3>=2.0.0",
          "PySocks>=1.7.1"
        )
        
        foreach ($package in $packages) {
          pip install $package
        }
    
    - name: åˆ›å»ºPyInstalleré…ç½®
      shell: pwsh
      run: |
        $specContent = @'
# -*- mode: python ; coding: utf-8 -*-
import os
from PyInstaller.utils.hooks import collect_data_files

# æ”¶é›†customtkinteræ•°æ®æ–‡ä»¶
customtkinter_datas = collect_data_files('customtkinter')

a = Analysis(
    ['main.py'],
    pathex=[],
    binaries=[],
    datas=customtkinter_datas,
    hiddenimports=[
        'customtkinter', 'tkinter', 'requests', 'bs4', 'tqdm', 'stem',
        'fake_useragent', 'Crypto', 'ebooklib', 'urllib3'
    ],
    hookspath=[],
    hooksconfig={},
    runtime_hooks=[],
    excludes=['matplotlib', 'numpy', 'pandas'],
    win_no_prefer_redirects=False,
    win_private_assemblies=False,
    cipher=None,
    noarchive=False,
)

pyz = PYZ(a.pure, a.zipped_data, cipher=None)

exe = EXE(
    pyz,
    a.scripts,
    a.binaries,
    a.zipfiles,
    a.datas,
    [],
    name='FanqieDownloader',
    debug=False,
    bootloader_ignore_signals=False,
    strip=False,
    upx=True,
    upx_exclude=[],
    runtime_tmpdir=None,
    console=False,
    disable_windowed_traceback=False,
    argv_emulation=False,
    target_arch=None,
    codesign_identity=None,
    entitlements_file=None,
)
'@
        
        $specContent | Out-File -FilePath "auto_build.spec" -Encoding UTF8
    
    - name: ç¼–è¯‘exe
      shell: pwsh
      run: |
        pyinstaller auto_build.spec --clean --noconfirm
    
    - name: ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯
      id: version
      shell: pwsh
      run: |
        $version = "v$(Get-Date -Format 'yyyy.MM.dd.HHmm')"
        echo "tag=$version" >> $env:GITHUB_OUTPUT
        
        # è·å–æäº¤ä¿¡æ¯
        $commits = git log --oneline -20 --pretty=format:"- %s"
        $body = @"
## ğŸ… ç•ªèŒ„å°è¯´ä¸‹è½½å™¨ $version

### ğŸ“… å‘å¸ƒæ—¶é—´
$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')

### ğŸ“ æ›´æ–°å†…å®¹
$commits

### ğŸ’¾ ä½¿ç”¨è¯´æ˜
1. ä¸‹è½½ FanqieDownloader.exe æ–‡ä»¶
2. åŒå‡»è¿è¡Œå³å¯ä½¿ç”¨
3. æ”¯æŒ Windows 10+ ç³»ç»Ÿ

### âš ï¸ æ³¨æ„äº‹é¡¹
- é¦–æ¬¡è¿è¡Œå¯èƒ½è¢«æ€æ¯’è½¯ä»¶æ‹¦æˆªï¼Œè¯·æ·»åŠ ä¿¡ä»»
- å¦‚é‡é—®é¢˜è¯·åœ¨ Issues ä¸­åé¦ˆ
"@
        
        $body | Out-File -FilePath "release_notes.md" -Encoding UTF8
    
    - name: åˆ›å»ºRelease
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.tag }}
        name: ç•ªèŒ„å°è¯´ä¸‹è½½å™¨ ${{ steps.version.outputs.tag }}
        body_path: release_notes.md
        files: dist/FanqieDownloader.exe
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
