name: è‡ªåŠ¨ç¼–è¯‘å‘å¸ƒ

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•ä»¥ä¾¿è·å–æäº¤ä¿¡æ¯
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        # æ£€æŸ¥requirements.txtæ˜¯å¦å­˜åœ¨
        if (Test-Path "requirements.txt") {
          pip install -r requirements.txt
        } else {
          # å¦‚æœæ²¡æœ‰requirements.txtï¼Œå®‰è£…åŸºæœ¬ä¾èµ–
          pip install customtkinter requests beautifulsoup4 tqdm stem fake-useragent pycryptodome ebooklib lxml
        }
    
    - name: ç¼–è¯‘exeæ–‡ä»¶
      run: |
        # è®¾ç½®æ§åˆ¶å°ç¼–ç ä¸ºUTF-8
        [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
        $env:PYTHONIOENCODING = "utf-8"

        # æ£€æŸ¥specæ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if (Test-Path "build_exe.spec") {
          echo "ä½¿ç”¨ç°æœ‰çš„specæ–‡ä»¶ç¼–è¯‘..."
          pyinstaller build_exe.spec --clean
        } else {
          echo "ä½¿ç”¨é»˜è®¤é…ç½®ç¼–è¯‘..."
          pyinstaller --onefile --windowed --name "ç•ªèŒ„å°è¯´ä¸‹è½½å™¨" main.py
        }
    
    - name: ç”Ÿæˆç‰ˆæœ¬å·å’Œå‘å¸ƒä¿¡æ¯
      id: release_info
      run: |
        # ç”ŸæˆåŸºäºæ—¥æœŸçš„ç‰ˆæœ¬å·
        $version = "v$(Get-Date -Format 'yyyy.MM.dd.HHmm')"
        echo "version=$version" >> $env:GITHUB_OUTPUT
        
        # è·å–æœ€è¿‘20æ¬¡æäº¤ä¿¡æ¯
        $commits = git log --oneline -20 --pretty=format:"- %s (%an)"
        $release_body = @"
        ## ğŸš€ è‡ªåŠ¨å‘å¸ƒç‰ˆæœ¬ $version
        
        ### ğŸ“… å‘å¸ƒæ—¶é—´
        $(Get-Date -Format 'yyyyå¹´MMæœˆddæ—¥ HH:mm:ss')
        
        ### ğŸ“ æ›´æ–°å†…å®¹ï¼ˆæœ€è¿‘20æ¬¡æäº¤ï¼‰
        $commits
        
        ### ğŸ’¾ ä¸‹è½½è¯´æ˜
        - ä¸‹è½½ ``ç•ªèŒ„å°è¯´ä¸‹è½½å™¨.exe`` æ–‡ä»¶
        - åŒå‡»è¿è¡Œå³å¯ä½¿ç”¨ï¼Œæ— éœ€å®‰è£…Pythonç¯å¢ƒ
        - æ”¯æŒWindows 10åŠä»¥ä¸Šç³»ç»Ÿ
        
        ### âš ï¸ æ³¨æ„äº‹é¡¹
        - é¦–æ¬¡è¿è¡Œå¯èƒ½è¢«æ€æ¯’è½¯ä»¶è¯¯æŠ¥ï¼Œè¯·æ·»åŠ ä¿¡ä»»
        - å»ºè®®åœ¨ä¸‹è½½å‰å…³é—­æ€æ¯’è½¯ä»¶çš„å®æ—¶ä¿æŠ¤
        - å¦‚æœ‰é—®é¢˜è¯·åœ¨Issuesä¸­åé¦ˆ
        "@
        
        # å°†å‘å¸ƒå†…å®¹å†™å…¥æ–‡ä»¶
        $release_body | Out-File -FilePath release_body.txt -Encoding UTF8
        echo "release_body_file=release_body.txt" >> $env:GITHUB_OUTPUT
    
    - name: æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
      run: |
        if (Test-Path "dist/ç•ªèŒ„å°è¯´ä¸‹è½½å™¨.exe") {
          echo "âœ… exeæ–‡ä»¶ç¼–è¯‘æˆåŠŸ"
          $size = (Get-Item "dist/ç•ªèŒ„å°è¯´ä¸‹è½½å™¨.exe").Length / 1MB
          echo "ğŸ“¦ æ–‡ä»¶å¤§å°: $([math]::Round($size, 2)) MB"
        } else {
          echo "âŒ exeæ–‡ä»¶ç¼–è¯‘å¤±è´¥"
          exit 1
        }
    
    - name: åˆ›å»ºRelease
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.release_info.outputs.version }}
        release_name: ç•ªèŒ„å°è¯´ä¸‹è½½å™¨ ${{ steps.release_info.outputs.version }}
        body_path: ${{ steps.release_info.outputs.release_body_file }}
        draft: false
        prerelease: false
    
    - name: ä¸Šä¼ exeæ–‡ä»¶
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: dist/ç•ªèŒ„å°è¯´ä¸‹è½½å™¨.exe
        asset_name: ç•ªèŒ„å°è¯´ä¸‹è½½å™¨.exe
        asset_content_type: application/octet-stream
    
    - name: å‘å¸ƒå®Œæˆé€šçŸ¥
      run: |
        echo "ğŸ‰ å‘å¸ƒå®Œæˆï¼"
        echo "ğŸ“¦ ç‰ˆæœ¬å·: ${{ steps.release_info.outputs.version }}"
        echo "ğŸ”— ä¸‹è½½é“¾æ¥: https://github.com/${{ github.repository }}/releases/tag/${{ steps.release_info.outputs.version }}"
